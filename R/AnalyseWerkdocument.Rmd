---
title: "Resultaten enquete interne communicatie 2016"
author: "Irina de Landsheer & Toon Van Daele"
date: "29 augustus 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(plyr)
library(dplyr)
library(tidyr)
library(pander)
library(ggplot2)
```

```{r load data}
path <- "C:/Users/toon_vandaele/toon.vandaele@inbo.be/Project/CommunicatieEnquete_analyse/data/"
df.Resp <- readRDS(file = paste0(path, "Resp.Rdata"))
df.Q <- readRDS(file = paste0(path, "Q.Rdata"))
df.AType <- readRDS(file = paste0(path, "AType.Rdata"))
```

## Typering van de respondenten per categorie

```{r aantallen per catetogrie, results='asis'}
countTable <- function(Qn) { 
  cat(df.Q[df.Q$VraagID == Qn,]$VraagTitel, "\n")
  df.Resp %>%
    dplyr::rename(Respons = Resp) %>%
    dplyr::filter(Q == Qn) %>%
    dplyr::group_by(jaar) %>%
    dplyr::count(Respons) %>%
    tidyr::spread(jaar, n) %>%
    pandoc.table()
  cat("\n")
}

countTable("Q1")
countTable("Q2")
countTable("Q3")
countTable("Q4")
```

## Aantallen per unieke combinatie 2016

```{r results='asis'}
Qcat <- c("Q1", "Q2", "Q3", "Q4")
  df.Resp %>% 
  filter(jaar == 2016, Q %in% Qcat) %>%
  spread(key = Q, value = Resp) %>%
  plyr::count(vars = Qcat) %>%
  pandoc.table()  
```

```{r}
# Aantal antwoorden per vraag
df.Resp$jaar <- factor(df.Resp$jaar, levels = c(2016,2014,2012), ordered = TRUE)

temp <- df.Resp %>%
  dplyr::filter(!Resp == "Weet niet") %>%
  plyr::count(vars = c("jaar", "Q", "Resp"))

tmpsum <- temp %>%
  dplyr::group_by(Q, jaar) %>%
  summarise(sum = sum(freq))

df.Respp <- dplyr::left_join(temp, tmpsum, by = c("jaar", "Q"))
df.Respp$Percentage <- df.Respp$freq / df.Respp$sum * 100

df.RespNA <- df.Resp %>%
  dplyr::filter(Resp == "Weet niet") %>%
  plyr::count(vars = c("jaar", "Q", "Resp"))
colnames(df.RespNA)[3:4] <- c("Wn", "nWn")

df.Respp <- dplyr::left_join(df.Respp, df.RespNA, by = c("jaar", "Q"))
df.Respp$nWn[is.na(df.Respp$nWn)] <- 0
df.Respp <- dplyr::left_join(df.Respp, df.AType, by = c("Resp" = "Level"))
```

```{r scores}
df.Score <- df.Respp %>%
  dplyr::filter(TypeID == "ANA") %>%
  dplyr::group_by(jaar, Q) %>%
  dplyr::summarise(Index = round(mean(Score * Percentage), 0))
```

```{r fig.height=0.7, fig.width=5}
get_legend <- function(myplot){

    tmp <- ggplot_gtable(ggplot_build(myplot))
    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
    legend <- tmp$grobs[[leg]]
    return(legend)
}

create_legend <- function(LegendType, df.AType) {

  df.dummyplot <- df.AType %>%
    dplyr::filter(TypeID == LegendType, !Level == "Weet niet" ) %>%
    dplyr::select(Level, Sort) %>%
    data.frame(y = 1)
  df.dummyplot$Level <- factor(df.dummyplot$Level, levels = df.dummyplot$Level[order(df.dummyplot$Sort)])
    
  dummyplot <- ggplot(df.dummyplot, aes(x = Level, y = y, fill = Level)) +
      geom_bar(stat = 'identity') +
      scale_fill_brewer(palette = 'RdYlGn') +
      labs(fill = "") +
      theme(legend.text = element_text(size = 8),
            legend.direction = "horizontal",
            legend.background =  element_rect(colour = "black"))
  
  mylegend <- get_legend(dummyplot)
  return(mylegend)
}

legendType <- list(ANA = create_legend("ANA", df.AType),
                   GoedSlecht = create_legend("GoedSlecht", df.AType))

#grid::grid.draw(legendType[["ANA"]])
```

```{r }
PlotStackedAll <- function(myQ) {

  df.plot <- df.Respp %>%
    filter(Q == myQ) %>%
    dplyr::left_join(df.Q, by = c("Q" = "VraagID"))
  
  # Ook levels met 0 antwoorden moeten worden getoond
  myAType <- filter(df.Q, VraagID == myQ)$AntwoordTypeID
  mylevels <- filter(df.AType, TypeID == myAType, !Level == "Weet niet")$Level
  df.plot$Resp <- factor(df.plot$Resp, levels = mylevels, ordered = TRUE)
  df.plot <- df.plot[order(df.plot$Resp, df.plot$jaar),]
    
  myMainTitle <- paste(myQ, ":", df.plot$VraagTitel[1])
  mySubTitle <- ifelse(df.plot$VraagTitelVervolg[1] == "Reactie", " ",
                       df.plot$VraagTitelVervolg[1])

  #labels
  df.plot <- df.plot %>%
    dplyr::group_by(jaar) %>%
    dplyr::mutate(labely = cumsum(Percentage) - (0.5 * Percentage))
  
  labelx <- unique(paste0(df.plot$jaar, "\n (n=", df.plot$sum, ") \n (NA=", df.plot$nWn))
  
  myplot <- ggplot(arrange(df.plot, Resp),
                   aes(x = jaar, y = Percentage, fill = Resp, order = Resp)) + 
    geom_bar(stat = 'identity') +
    geom_text(aes(y = labely, label = round(Percentage, 0))) +
    scale_y_continuous("Percentage (%)") +
    scale_x_discrete(labels = labelx) +
    ggtitle(mySubTitle) +
    coord_flip() + 
    scale_fill_brewer(palette = 'RdYlGn') +
    theme(axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "none",
        axis.text.y = element_text(vjust = 0.8, face = 'bold'))

  # Output
  
  cat("\n")
  cat("### ", myMainTitle, "\n")
  grid::grid.draw(myplot)
  cat("\n")
 
  df.Score %>%
    filter(Q == myQ) %>%
    select(jaar, Index) %>%
    dplyr::arrange(desc(jaar)) %>%
    t() %>%
    pander::pandoc.table()
 
  cat("\n")
  grid::grid.draw(legendType[["ANA"]])
  cat("\n")
  
}
```

# Responses

```{r results = 'asis', fig.height=2}
Qlist <- cbind(df.Q[8:10,1])
m_ply(.data = Qlist, .fun = PlotStackedAll)
```
